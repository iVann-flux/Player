<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AllInOne Reborn Player</title>
    
    <!-- Shaka Player & Material Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .video-container { width: 100%; height: 100%; background: #000; position: relative; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* মাঝখানের কন্ট্রোলস (Play/Skip) - ২ নম্বর ছবির মতো */
        .center-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; align-items: center; gap: 40px; z-index: 10; opacity: 0; transition: opacity 0.3s;
            pointer-events: none;
        }
        .center-btn {
            background: rgba(0,0,0,0.5); border: none; color: white; border-radius: 50%; padding: 15px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; pointer-events: auto;
        }
        .material-icons.large { font-size: 60px; }
        .material-icons.medium { font-size: 40px; }

        /* নিচের লাল সিকার বার এবং কন্ট্রোলস */
        .custom-controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 10px 15px; opacity: 0; transition: opacity 0.3s; z-index: 20;
        }
        .seek-bar-container { width: 100%; height: 5px; background: rgba(255,255,255,0.3); cursor: pointer; position: relative; margin-bottom: 10px; }
        .seek-fill { height: 100%; background: #ff0000; width: 0%; position: absolute; top: 0; left: 0; }
        
        .buttons-row { display: flex; justify-content: space-between; align-items: center; }
        .left-buttons, .right-buttons { display: flex; gap: 15px; align-items: center; }
        
        .icon-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; }
        .material-icons { font-size: 28px; }
        .time-text { font-size: 14px; font-weight: bold; }

        /* বাফারিং স্পিনার */
        .spinner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2);
            border-top: 5px solid #ff0000; border-radius: 50%;
            animation: spin 0.8s linear infinite; z-index: 25; display: none;
        }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* মাউস নাড়লে কন্ট্রোল দেখাবে */
        .video-container:hover .custom-controls, .video-container:hover .center-overlay { opacity: 1; }
        #error-msg { position: absolute; top: 40%; width: 100%; text-align: center; color: #ff4444; z-index: 30; display: none; }
    </style>
</head>
<body>

    <div class="video-container" id="video-container" onclick="toggleUI()">
        <video id="video" autoplay playsinline></video>
        <div id="error-msg">Loading...</div>
        <div class="spinner" id="loading-spinner"></div>

        <!-- মাঝখানের বাটন (ছবি ২ অনুযায়ী) -->
        <div class="center-overlay" id="center-controls">
            <div class="center-btn" onclick="event.stopPropagation(); skip(-10)"><span class="material-icons medium">replay_10</span></div>
            <div class="center-btn" onclick="event.stopPropagation(); togglePlay()"><span class="material-icons large" id="main-play-icon">pause</span></div>
            <div class="center-btn" onclick="event.stopPropagation(); skip(10)"><span class="material-icons medium">forward_10</span></div>
        </div>

        <!-- নিচের লাল সিকার বার এবং বাটনস -->
        <div class="custom-controls" id="controls" onclick="event.stopPropagation()">
            <div class="seek-bar-container" onclick="seek(event)"><div class="seek-fill" id="seek-fill"></div></div>
            <div class="buttons-row">
                <div class="left-buttons">
                    <button class="icon-btn" onclick="togglePlay()"><span class="material-icons" id="play-icon">pause</span></button>
                    <button class="icon-btn" onclick="toggleMute()"><span class="material-icons" id="vol-icon">volume_up</span></button>
                    <span class="time-text" id="time-display">0:00 / 0:00</span>
                </div>
                <div class="right-buttons">
                    <button class="icon-btn" onclick="toggleFull()"><span class="material-icons">fullscreen</span></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let player;
        const video = document.getElementById('video');
        const spinner = document.getElementById('loading-spinner');
        let hideTimeout;

        async function init() {
            shaka.polyfill.installAll();
            player = new shaka.Player(video);

            const params = new URLSearchParams(window.location.search);
            const channelId = params.get('play');

            if (!channelId) { showError("Use ?play=CHANNEL_ID"); return; }

            try {
                const response = await fetch("https://allinonereborn.online/jstrweb2/jstr.json");
                const channelList = await response.json();
                const channel = channelList.find(c => c.channel_id == channelId);

                if (channel) {
                    document.title = channel.name;

                    // নেটওয়ার্ক এবং টোকেন ফিল্টার
                    player.getNetworkingEngine().registerRequestFilter((type, request) => {
                        request.headers['User-Agent'] = channel.userAgent || '@allinone_reborn';
                        request.headers['Referer'] = channel.referer || 'https://www.jiotv.com/';

                        if (channel.token && (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT)) {
                            const separator = request.uris[0].includes('?') ? '&' : '?';
                            if (!request.uris[0].includes('__hdnea__')) {
                                request.uris[0] += separator + channel.token;
                            }
                        }
                    });

                    // DRM কনফিগারেশন
                    if (channel.drm) {
                        player.configure({ drm: { clearKeys: channel.drm } });
                    }
                    
                    player.configure({ streaming: { lowLatencyMode: true } });

                    await player.load(channel.mpd);
                    startTimer();
                } else { showError("Channel Not Found!"); }
            } catch (e) { showError("Error Loading Stream"); }
        }

        // কন্ট্রোল ফাংশনস
        function togglePlay() {
            if (video.paused) { video.play(); updateIcons('pause'); } 
            else { video.pause(); updateIcons('play_arrow'); }
        }
        function updateIcons(icon) {
            document.getElementById('play-icon').innerText = icon;
            document.getElementById('main-play-icon').innerText = icon;
        }
        function toggleMute() {
            video.muted = !video.muted;
            document.getElementById('vol-icon').innerText = video.muted ? 'volume_off' : 'volume_up';
        }
        function skip(time) { video.currentTime += time; }
        function toggleFull() {
            if (!document.fullscreenElement) document.getElementById('video-container').requestFullscreen();
            else document.exitFullscreen();
        }
        function seek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            video.currentTime = pos * video.duration;
        }
        function startTimer() {
            video.ontimeupdate = () => {
                const percent = (video.currentTime / video.duration) * 100;
                document.getElementById('seek-fill').style.width = percent + '%';
                document.getElementById('time-display').innerText = formatTime(video.currentTime) + " / " + formatTime(video.duration);
            };
        }
        function formatTime(s) { const m = Math.floor(s/60), r = Math.floor(s%60); return m + ":" + (r<10?'0':'') + r; }
        function showError(m) { const e = document.getElementById('error-msg'); e.innerText = m; e.style.display = 'block'; }
        
        video.addEventListener('waiting', () => spinner.style.display = 'block');
        video.addEventListener('playing', () => spinner.style.display = 'none');

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
