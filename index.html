<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>AllInOne Reborn Player</title>

    <!-- Shaka Player Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: sans-serif;
        }
        .shaka-video-container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* Error Modal */
        .error-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            text-align: center;
        }
        .hidden { display: none !important; }
        .error-content { background: #222; padding: 30px; border-radius: 15px; border: 1px solid #444; max-width: 80%; }
        .error-content h3 { color: #ff4444; margin-bottom: 10px; }
    </style>
</head>

<body>

    <div id="errorModal" class="error-modal hidden">
        <div class="error-content">
            <h3 id="errorTitle">Oops!</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <div class="shaka-video-container" id="video-container">
        <video id="video" autoplay muted playsinline></video>
    </div>

    <script>
    async function initPlayer() {
        // ১. URL থেকে id প্যারামিটার নেওয়া (?id=143)
        const urlParams = new URLSearchParams(window.location.search);
        const idFromUrl = urlParams.get('id');

        if (!idFromUrl) {
            showError("Please provide a Channel ID (e.g. ?id=143)");
            return;
        }

        // ২. তোমার দেওয়া জেসন লিঙ্ক থেকে ডেটা নিয়ে আসা
        let channelData;
        try {
            const response = await fetch('https://allinonereborn.online/jstrweb2/jstr.json');
            const channels = await response.json();
            
            // তোমার জেসন অনুযায়ী 'channel_id' ম্যাচ করানো হচ্ছে
            channelData = channels.find(c => c.channel_id === idFromUrl);
        } catch (e) {
            showError("Failed to load channel list.");
            return;
        }

        if (!channelData) {
            showError("Channel ID " + idFromUrl + " not found!");
            return;
        }

        // ৩. শাকা প্লেয়ার ইনিশিয়ালাইজ করা
        shaka.polyfill.installAll();
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('video-container');
        const player = new shaka.Player(video);
        const ui = new shaka.ui.Overlay(player, videoContainer, video);

        // UI ডিজাইন কনফিগারেশন
        ui.configure({
            'controlPanelElements': ['play_pause', 'time_and_duration', 'spacer', 'quality', 'fullscreen'],
            'seekBarColors': {
                'base': 'rgba(255,255,255,0.2)',
                'buffered': 'rgba(255,255,255,0.4)',
                'played': 'rgb(255,0,0)' // লাল সিকার বার
            }
        });

        // ৪. ডিআরএম (DRM/ClearKeys) কনফিগারেশন
        if (channelData.drm) {
            player.configure({
                drm: {
                    clearKeys: channelData.drm // জেসন থেকে সরাসরি কী গুলো নিচ্ছে
                }
            });
        }

        // ৫. নেটওয়ার্ক ফিল্টার (Headers & Token)
        player.getNetworkingEngine().registerRequestFilter((type, request) => {
            // User-Agent সেট করা
            request.headers['User-Agent'] = channelData.userAgent || 'Mozilla/5.0';
            
            // Referer সেট করা
            if (channelData.referer) {
                request.headers['Referer'] = channelData.referer;
            }

            // টোকেন যোগ করা (যেমন: __hdnea__)
            if (channelData.token) {
                const separator = request.uris[0].includes('?') ? '&' : '?';
                request.uris[0] += separator + channelData.token;
            }
        });

        // ৬. ফাইনাল লোড
        try {
            await player.load(channelData.mpd); // 'mpd' লিঙ্ক ব্যবহার করে ভিডিও চলবে
            document.title = channelData.name; // ব্রাউজার ট্যাবে চ্যানেলের নাম দেখাবে
        } catch (error) {
            showError("Streaming Error: " + error.message);
        }
    }

    function showError(msg) {
        document.getElementById('errorMessage').innerText = msg;
        document.getElementById('errorModal').classList.remove('hidden');
    }

    // শাকা লোড হলে প্লেয়ার শুরু হবে
    document.addEventListener('shaka-ui-loaded', initPlayer);
    </script>

</body>
</html>
