<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>Playing Stream...</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #000; height: 100vh; width: 100vw; overflow: hidden; }
        .shaka-video-container { position: absolute; inset: 0; width: 100%; height: 100%; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .error-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; color: white; text-align: center; }
        .hidden { display: none !important; }
        .error-content { background: #222; padding: 30px; border-radius: 15px; border: 1px solid #444; }
    </style>
</head>

<body>

    <div id="errorModal" class="error-modal hidden">
        <div class="error-content">
            <h3 id="errorTitle">Stream Error</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <div class="shaka-video-container" id="video-container" data-shaka-player-container>
        <video id="video" autoplay muted playsinline></video>
    </div>

    <script>
    async function initApp() {
        // ১. পলিফিল ইনস্টল (সব ব্রাউজারে সাপোর্টের জন্য)
        shaka.polyfill.installAll();
        if (!shaka.Player.isBrowserSupported()) {
            showError("Browser not supported!");
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const idFromUrl = urlParams.get('id');

        if (!idFromUrl) {
            showError("No Channel ID provided in URL!");
            return;
        }

        // ২. ডাটা ফেচ করা
        let channelData;
        try {
            const response = await fetch('https://allinonereborn.online/jstrweb2/jstr.json');
            const channels = await response.json();
            channelData = channels.find(c => c.channel_id === idFromUrl);
        } catch (e) {
            showError("Failed to fetch channel list.");
            return;
        }

        if (!channelData) {
            showError("Channel ID not found!");
            return;
        }

        // ৩. প্লেয়ার সেটাআপ
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('video-container');
        const player = new shaka.Player(video);
        const ui = new shaka.ui.Overlay(player, videoContainer, video);

        // অরিজিনাল স্ক্রিপ্ট অনুযায়ী কনফিগারেশন
        player.configure({
            drm: {
                clearKeys: channelData.drm || {}
            },
            streaming: {
                lowLatencyMode: true,
                bufferingGoal: 25,
                rebufferingGoal: 5,
                ignoreTextStreamFailures: true
            }
        });

        // ৪. নেটওয়ার্ক ইঞ্জিন (মোস্ট ইম্পর্ট্যান্ট পার্ট)
        player.getNetworkingEngine().registerRequestFilter(function(type, request) {
            // অরিজিনাল স্ক্রিপ্টের মতো হেডার সেট করা
            request.headers['User-Agent'] = channelData.userAgent || '@allinone_reborn';
            request.headers['Referer'] = channelData.referer || 'https://www.jiotv.com/';

            // ৫. টোকেন ইনজেকশন (URI ফিল্টার)
            // এটি প্রতিটি সেগমেন্ট রিকোয়েস্টের শেষে টোকেন যোগ করবে যাতে ভিডিও আনলক হয়
            if (type == shaka.net.NetworkingEngine.RequestType.MANIFEST || type == shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                if (channelData.token) {
                    const uri = request.uris[0];
                    if (!uri.includes('__hdnea__')) { // যদি অলরেডি টোকেন না থাকে
                        const separator = uri.includes('?') ? '&' : '?';
                        request.uris[0] = uri + separator + channelData.token;
                    }
                }
            }
        });

        // ৬. ভিডিও লোড
        try {
            await player.load(channelData.mpd);
            document.title = channelData.name;
        } catch (error) {
            showError("Player Load Error: " + error.message);
        }
    }

    function showError(msg) {
        document.getElementById('errorMessage').innerText = msg;
        document.getElementById('errorModal').classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
